---
- name: 'install dependency'
  yum:
    name: "{{ nrpe_dependency_package }}"
    state: 'present'

- name: 'install nrpe'
  yum:
    name: 'nrpe'
    state: 'present'

- name: 'configure nrpe'
  template:
    src: 'nrpe.cfg.j2'
    dest: '/etc/nagios/nrpe.cfg'
    owner: "{{ nrpe_user }}"
    group: "{{ nrpe_group }}"
    mode: '0644'
  notify: 'restarting nrpe service'

- name: 'create nrpe_pid path'
  file:
    path: "{{ nrpe_pid_path }}"
    state: 'directory'
    owner: "{{ nrpe_user }}"
    group: "{{ nrpe_group }}"
    mode: '0775'

- name: 'Set user for the service'
  lineinfile:
    path: "{{ systemd_file_path }}"
    regexp: '^User=.*'
    line: "User={{ nrpe_user }}"
  notify: 'restarting nrpe service'

- name: 'Set group for the service'
  lineinfile:
    path: "{{ systemd_file_path }}"
    regexp: '^Group=.*'
    line: "Group={{ nrpe_user }}"
  notify: 'restarting nrpe service'

- name: 'enable nrpe service and ensure it is started'
  service:
    name: 'nrpe'
    enabled: 'yes'
    state: 'started'
